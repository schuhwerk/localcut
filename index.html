<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LocalCut</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<script src="coi-serviceworker.js"></script>
<script src="lib/ffmpeg.js"></script>
<script src="lib/ffmpeg-util.js"></script>
<script src="lib/marked.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="drop" class="overlay"><h1>Drop File</h1></div>
<div id="toast"></div>

<div id="log-ov" class="overlay">
    <div class="modal">
        <h3>Processing Output</h3>
        <div id="log-con"></div>
        <div class="f-row" style="justify-content:flex-end">
            <button class="btn" onclick="$('log-ov').style.display='none'">Close</button>
            <button class="btn btn-p" id="cp-btn" onclick="copyLog()">Copy Log</button>
        </div>
    </div>
</div>

<div id="sets-ov" class="overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal">
        <h3>Settings</h3>
        <div class="set-row">
            <div><label>Quality (CRF)</label><small>18=High, 23=Default, 28=Low</small></div>
            <input type="number" id="s-crf" value="23" style="width:60px">
        </div>
        <div class="set-row">
            <label>Rotation</label>
            <select id="s-rot"><option value="0">0°</option><option value="90">90° CW</option><option value="180">180°</option><option value="270">90° CCW</option></select>
        </div>
        <div class="set-row">
            <label>Scale (1.0 = 100%)</label>
            <input type="number" id="s-sc" value="1.0" step="0.1" style="width:60px">
        </div>
        <div class="set-row"><label>Keep Metadata</label><input type="checkbox" id="s-meta" checked></div>
        <div class="set-row"><label>CUDA Command</label><input type="checkbox" id="s-cuda"></div>
        <div class="f-row" style="justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-p" style="width:100%" onclick="$('sets-ov').style.display='none'">Done</button>
        </div>
    </div>
</div>

<div id="help-ov" class="overlay" onclick="if(event.target===this)this.style.display='none'"><div class="modal" id="md-con"></div></div>

<div class="hud f-row">
    <span style="font-weight:700; color:#fff">✂</span>
    <button class="btn btn-icon" onclick="$('sets-ov').style.display='flex'">⚙️</button>
    <button class="btn btn-icon" onclick="showHelp()">?</button>
    
    <div class="f-grow f-col" style="align-items:center; justify-content:center">
        <div class="fname" id="fname">No File Loaded</div>
        <span class="keys">[Space] Play/Pause &nbsp; [I] In &nbsp; [O] Out &nbsp; [Enter] Add</span>
    </div>

    <div class="f-row" style="gap:2px">
        <span class="stat" id="tm">0:00</span>
        <button class="btn btn-icon" style="width:24px" onclick="spd(-0.25)">-</button>
        <span class="stat" id="spdv" style="min-width:30px">1x</span>
        <button class="btn btn-icon" style="width:24px" onclick="spd(0.25)">+</button>
    </div>
</div>

<div class="vid-box">
    <div id="empty">
        <h2>Drop Video Here</h2>
        <button class="btn btn-p" onclick="$('f-in').click()">Browse Files</button>
        <input type="file" id="f-in" accept="video/*" hidden onchange="load(this.files[0])">
    </div>
    <video id="v" controls playsinline style="display:none"></video>
</div>

<div id="editor">
    <div class="row-head">
        <span>Segments<span class="info-lbl">(Merged by name)</span></span>
        <div class="f-row">
            <button class="btn" onclick="genCmd()">Cmd</button>
            <button class="btn btn-p" id="b-cut" onclick="proc()">✂ Cut</button>
        </div>
    </div>
    <div class="list" id="lst"></div>
</div>

<script>
const $ = id => document.getElementById(id);
const vid = $('v');
let file = null, secs = [], draft = {s:0, e:0, n:''}, ffmpeg = null;

// INIT & DRAG/DROP
window.ondragenter = () => $('drop').style.display = 'flex';
window.ondragleave = e => { if(!e.relatedTarget) $('drop').style.display = 'none'; };
window.ondragover = e => e.preventDefault();
window.ondrop = e => { e.preventDefault(); $('drop').style.display='none'; if(e.dataTransfer.files[0]) load(e.dataTransfer.files[0]); };

function load(f) {
    file = f;
    $('fname').innerText = f.name;
    $('empty').style.display = 'none';
    vid.style.display = 'block';
    if(vid.src) URL.revokeObjectURL(vid.src);
    vid.src = URL.createObjectURL(f);
    
    // Restore
    secs = []; draft = {s:0,e:0,n:''};
    try {
        const d = JSON.parse(localStorage.getItem(`lc_${f.name}_${f.size}`));
        if(d) { secs = d.secs || (Array.isArray(d)?d:[]); draft = d.dft || draft; toast(`Restored ${secs.length}`); }
    } catch(e){}
    
    if(!draft.n) draft.n = (secs.length+1)+'';
    render();
}

function save() { if(file) localStorage.setItem(`lc_${file.name}_${file.size}`, JSON.stringify({secs, dft:draft})); }

// PLAYER
vid.ontimeupdate = () => $('tm').innerText = (vid.currentTime/60|0) + ':' + (vid.currentTime%60).toFixed(1).padStart(4,'0');
function spd(d) { vid.playbackRate = Math.max(0.25, vid.playbackRate+d); $('spdv').innerText = vid.playbackRate+'x'; }

// EDITOR RENDER
function render() {
    $('lst').innerHTML = secs.map((s,i) => row(i, s)).join('') + row(-1, draft, true);
}

function row(i, d, isD) {
    const fn = (f,v) => isD ? `draft.${f}=${v};save();render()` : `secs[${i}].${f}=${v};save()`;
    const set = f => isD ? `draft.${f}=vid.currentTime.toFixed(2);save();render()` : `secs[${i}].${f}=vid.currentTime.toFixed(2);save();render()`;
    const nameFn = isD ? `draft.n=this.value;save()` : `secs[${i}].n=this.value;save()`;
    
    // Original Group HTML structure
    const grp = (f,v,k) => `
    <div class="t-grp">
        <button class="t-btn play" onclick="vid.currentTime=${v};vid.play()">▶</button>
        <button class="t-btn set" onclick="${set(f)}" title="Set ${k}">⌖</button>
        <input type="number" class="t-in" step="0.1" value="${v}" onchange="${fn(f,'parseFloat(this.value)')}">
    </div>`;

    // Original Row HTML structure
    return `<div class="row ${isD?'draft':''}">
        ${grp('s', d.s, 'In (I)')} ${grp('e', d.e, 'Out (O)')}
        <input class="name-in" value="${d.n}" onchange="${nameFn}" placeholder="Name">
        ${isD ? `<button class="act-btn add" onclick="add()">＋</button>` 
              : `<button class="act-btn del" onclick="secs.splice(${i},1);save();render()">×</button>`}
    </div>`;
}

function add() {
    if(draft.e <= draft.s) return toast('End time must be after Start');
    secs.push({...draft});
    draft.s = parseFloat(vid.currentTime.toFixed(2)); draft.e = 0; draft.n = (secs.length+1)+'';
    save(); render();
    setTimeout(() => $('lst').scrollTop = $('lst').scrollHeight, 50);
}

// HOTKEYS
window.onkeydown = e => {
    if(e.target.tagName==='INPUT') return;
    const k = e.key.toLowerCase();
    if(k===' ') { e.preventDefault(); vid.paused?vid.play():vid.pause(); }
    if(k==='i') { draft.s = vid.currentTime.toFixed(2); save(); render(); }
    if(k==='o') { draft.e = vid.currentTime.toFixed(2); save(); render(); }
    if(k==='enter') add();
};

// PROCESSING
function getSegs() {
    const arr = [...secs];
    if(draft.e > draft.s) arr.push({...draft, n: draft.n || 'draft'});
    return arr.filter(s => s.e > s.s);
}

function getCmds(isWasm) {
    const segs = getSegs();
    if(!segs.length) return null;
    const grps = {}; segs.forEach(s => (grps[s.n] = grps[s.n]||[]).push(s));
    
    const rot = $('s-rot').value, scale = $('s-sc').value;
    const cmds = [];

    for(let k in grps) {
        let f = "", m = "";
        grps[k].forEach((s,i) => {
            f += `[0:v]trim=${s.s}:${s.e},setpts=PTS-STARTPTS[v${i}];[0:a]atrim=${s.s}:${s.e},asetpts=PTS-STARTPTS[a${i}];`;
            m += `[v${i}][a${i}]`;
        });
        f += `${m}concat=n=${grps[k].length}:v=1:a=1[v][a]`;
        
        let vf = [];
        if(scale != 1) vf.push(`scale=iw*${scale}:-1`);
        if(rot == 90) vf.push("transpose=1"); else if(rot==180) vf.push("transpose=2,transpose=2"); else if(rot==270) vf.push("transpose=2");
        if(vf.length) f += `;[v]${vf.join(',')}[outv]`; else f+=`;[v]null[outv]`;

        cmds.push({ name: `cut_${file.name.split('.')[0]}_${k}.mp4`, filter: f, map: ['[outv]','[a]'] });
    }
    return cmds;
}

function genCmd() {
    if(!file) return toast('No file loaded');
    const cmds = getCmds(false);
    if(!cmds) return toast('No segments defined');
    const crf = $('s-crf').value, cuda = $('s-cuda').checked, meta = $('s-meta').checked;
    const log = cmds.map(c => 
        `ffmpeg -i "${file.name}" -filter_complex "${c.filter}" -map "${c.map[0]}" -map "${c.map[1]}" ${cuda?`-c:v h264_nvenc -cq ${crf}`:`-c:v libx264 -crf ${crf}`} -c:a aac ${meta?'-map_metadata 0':'-map_metadata -1'} "${c.name}"`
    ).join('\n\n');
    showLog(log);
}

async function proc() {
    if(!file) return;
    const cmds = getCmds(true);
    if(!cmds) return toast('No segments defined');
    
    const btn = $('b-cut'); btn.disabled=true; btn.innerText='Wait...';
    $('log-ov').style.display='flex';
    const l = $('log-con'); l.innerText = "Initializing WASM...\n";
    const log = s => { l.innerText+=s+'\n'; l.scrollTop=l.scrollHeight; };

    try {
        // FIXED: Extract util functions from global FFmpegUtil object
        const { fetchFile, toBlobURL } = FFmpegUtil;

        if(!ffmpeg) {
            const F = window.FFmpegWASM?.FFmpeg || window.FFmpeg;
            ffmpeg = new F();
            ffmpeg.on('log', ({message})=>log(message));
            await ffmpeg.load({
                coreURL: await toBlobURL(`lib/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`lib/ffmpeg-core.wasm`, 'application/wasm'),
                workerURL: await toBlobURL(`lib/814.ffmpeg.js`, 'text/javascript')
            });
        }
        
        log('Reading File...');
        await ffmpeg.writeFile(file.name, await fetchFile(file));
        
        for(let c of cmds) {
            log(`Processing ${c.name}...`);
            await ffmpeg.exec([
                '-i', file.name, '-filter_complex', c.filter,
                '-map', c.map[0], '-map', c.map[1],
                '-c:v', 'libx264', '-crf', $('s-crf').value, '-preset', 'ultrafast', '-c:a', 'aac',
                $('s-meta').checked?'-map_metadata':'', $('s-meta').checked?'0':'-1',
                c.name
            ].filter(Boolean));
            
            const d = await ffmpeg.readFile(c.name);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([d.buffer], {type:'video/mp4'}));
            a.download = c.name; a.click();
        }
        log('Done! Check downloads.');
    } catch(e) { log('Error: '+e.message); }
    btn.disabled=false; btn.innerText='✂ Cut';
}

async function showHelp() {
    $('help-ov').style.display = 'flex';
    if(!$('md-con').innerHTML) $('md-con').innerHTML = marked.parse(await (await fetch('README.md')).text());
}
function showLog(t) { $('log-ov').style.display='flex'; $('log-con').innerText=t; }
function copyLog() { navigator.clipboard.writeText($('log-con').innerText); $('cp-btn').innerText='Copied!'; setTimeout(()=>$('cp-btn').innerText='Copy Log',1500); }
function toast(m) { const t=$('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
</script>
</body>
</html>